## Introduction and Concepts 

虚拟化是IaaS云的一种支持技术

虚拟化是一个广泛的术语。它可以适用于所有类型资源(CPU、内存、网络等)
**让一台电脑“看起来”像多台电脑，通过共享一个任务的资源来完成多个任务**

### Several components

- Host
  - 底层的硬件系统 
- 虚拟机管理器（VMM）或超级监视器 
  - 通过提供与主机完全相同的接口来创建和运行虚拟机（除了半虚拟化的情况）
  - VMM 本质上是一个简单的操作系统 
- 虚拟机（VM） 
  - 是一种基于软件的对真实（基于硬件的）计算机的实现 
  - 在其纯粹形式中，支持未经修改的操作系统和应用程序的引导和执行 
- Guest
  - 通常是一个操作系统

![image-20240411182114870](assets\image-20240411182114870.png)

## Implementation of VMMs

### Type-0 hypervisors

基于硬件的解决方案，通过固件创建虚拟机和管理提供支持

### Type-1 hypervisors

类似操作系统的软件提供了一个虚拟化层，直接在一个干净的x86上的系统上

‣ e.g., VMware ESX, Joint SmartOS, Citrix XenServer 

‣ widely deployed in production clouds 

![image-20240411182239409](assets\image-20240411182239409.png)

还包括提供标准功能和VMM功能的通用操作系统

‣ e.g., Microsoft Windows Server w/ HyperV and RedHat Linux w/ KVM, Oracle Solaris 

‣ typically less feature rich than dedicated type-1 hypervisors



### Type-2 hypervisors

- VMM只是主机中另一个由进程运行和管理的组件
- 甚至主机也不知道它们是运行客户端的VMM 
- 通过主机操作系统间接访问硬件
  - 性能不佳  
  - 需要主机操作系统授予的管理权限
  - 通常用于桌面和个人使用，但不适用于生产云环境

### Other variations

**Para-virtualization** 

一种技术，通过修改客户操作系统与VMM协作以优化性能。

**Programming-environment virtualization** 

VMM不对真实硬件进行虚拟化，而是创建一个优化的虚拟系统，例如JVM和Microsoft.Net。

**Emulators** 

允许为一个硬件环境编写的应用程序在不同的硬件环境中运行，例如iOS模拟器。



### Summary

Type-1 hypervisors and para virtualization are the most popular choices on the cloud



## 计算机硬件-操作系统-应用程序 

![image-20240411182917552](assets\image-20240411182917552.png)



1. 计算机硬件包括 CPU、内存、I/O 设备等。CPU有指令集、寄存器、中断和特权模式；内存通过加载/存储方式访问；I/O 设备通过编程 I/O 或 DMA 控制，事件通过轮询或中断传递给软件。
2. 操作系统是一种特殊的软件层，提供应用程序对硬件资源的访问。它以特权（内核）CPU 模式运行，保护自身免受用户程序的影响，并能够使用“敏感”指令与硬件设备交互。
3. 应用程序是依赖于系统调用接口的程序。在执行时，CPU 运行在非特权（用户）模式下，通过特殊指令（如 x86 上的 int）调用操作系统。操作系统通过低级 HW 设备实现高级编程接口，例如文件操作。
4. 应用程序执行时，操作系统提供了自己的内存幻觉，通过 MMU 硬件定义了程序的“虚拟地址空间”，防止程序相互干扰和对操作系统内存的破坏。
5. 将硬件、操作系统和应用程序结合起来，形成了用户模式和内核模式之间的交互。内核模式下，应用程序具有有限的硬件访问权限，通过系统调用进入内核执行特权操作。

## Virtualization

### Full virtualization 

‣ Emulate + binary translation: this is rocket science and what VMware did! 

全虚拟化（Full virtualization）是一种虚拟化技术，它通过在虚拟机（VM）中模拟完整的硬件环境来实现。在全虚拟化中，虚拟机对于其运行的操作系统和应用程序来说，看起来就像是一个完整的独立计算机系统，而不需要对其进行修改。这意味着虚拟机可以运行未经修改的操作系统，并且能够在虚拟化环境中执行原生的二进制代码。

全虚拟化是一种虚拟化技术，其关键技术是二进制翻译。这种技术的基本原理很简单，但实现起来相对复杂。当客户虚拟 CPU 处于用户模式时，客户可以原生地运行指令；而当客户虚拟 CPU 处于（虚拟）内核模式时，虚拟机监视程序（hypervisor）会检查客户即将执行的每一条指令。普通指令会原生运行，而特殊指令则会被翻译为一组新的指令，以在模拟的硬件中执行等效的任务。

在全虚拟化中，虚拟机监视程序通过二进制翻译来模拟硬件。虚拟机监视程序向虚拟机的客户操作系统提供完整的模拟硬件集，例如，Microsoft Virtual Server 2005 模拟 Intel 21140 网卡和 Intel 440BX 芯片组。无论主机系统上的实际物理硬件是什么，模拟的硬件都保持不变。

在全虚拟化中，客户操作系统被欺骗以为自己在 Ring 0 特权级别下运行，实际上它在宿主系统的 Ring 1 中运行，虚拟机监视程序模拟硬件并拦截特权代码。非特权指令直接在 CPU 上执行。

全虚拟化的优点包括保持客户操作系统的未修改、防止不稳定的虚拟机影响系统性能以及虚拟机的可移植性。然而，全虚拟化的缺点包括性能不佳，可以通过优化缓存特殊指令的翻译来解决。

#### 错误方法

全虚拟化是错误的方法的主要原因在于它与x86架构设计不匹配。x86架构并不直接支持全虚拟化，因此在进行全虚拟化时，需要处理一些特权指令，但如果执行这些指令时权限不足，它们会静默失败，而不会引发方便的陷阱。此外，有效地虚拟化x86 MMU也很困难，需要维护一个影子页表。这些问题可以通过增加复杂性和降低性能的代价来解决，但是并不是理想的解决方案。

此外，全虚拟化还限制了操作系统能够看到的资源。在某些情况下，希望托管操作系统能够同时看到真实和虚拟资源。例如，提供真实和虚拟时间可以让客户操作系统更好地支持对时间敏感的任务，并正确处理TCP超时和RTT估计。同时，公开真实的机器地址可以让客户操作系统通过使用超大页或页面着色来提高性能。

### Para-virtualization 

‣ modify the guest OS to avoid non-virtualizable instructions 

Para-virtualization是一种旨在克服全虚拟化中硬件仿真的性能惩罚的虚拟化技术。相较于全虚拟化，Para-virtualization需要对客户操作系统的内核进行修改。其中最知名的实现是Xen。

在云计算中，Para-virtualization已成为事实上的虚拟化技术。例如，AWS EC2使用的就是Xen。Para-virtualization的优点包括更好的性能，因为它减少了对硬件的仿真，但缺点是需要对客户操作系统进行修改。

### Hardware-assisted virtualization 

硬件辅助虚拟化是一种利用硬件支持的虚拟化技术，旨在提高虚拟化性能和效率。在2005年，英特尔推出了“VT”（Virtualization Technology），而AMD在2006年推出了“Pacifica”（AMD-V），这两种技术重新实现了VM/370虚拟化支持的想法。它们基本上添加了一个新的CPU模式（“guest”和“host”），以区分虚拟机监视器（VMM）和客户操作系统/应用程序。

利用硬件辅助虚拟化，构建一个虚拟机监视器变得更加容易，这使得虚拟化软件供应商如VMware需要通过其他方式来盈利。

硬件辅助虚拟化通常包括几个步骤：

1. 初始状态下，机器正常执行，没有运行任何客户操作系统。
2. 当虚拟机监视器启动一个虚拟机时，控制从非特权模式切换到根模式。
3. 当客户操作系统运行特权指令时，例如需要系统控制的指令，将会陷入到虚拟机监视器（VM退出）。
4. 当虚拟机监视器完成操作后，控制再次切换回非特权模式，虚拟机继续执行。

硬件辅助虚拟化有望成为未来服务器虚拟化的标准，因为它提高了性能和效率，并且可以更轻松地构建虚拟化环境。

### 总结

![image-20240411183615525](assets\image-20240411183615525.png)

##  

## Cloud infrastructures

云计算通常与虚拟化相关联，因为云计算环境中的弹性和灵活性往往是通过虚拟化技术实现的。在云计算环境中，使用虚拟化技术启动新的虚拟机是便宜和快速的，而且将多个虚拟机合并到一台物理机器上可以提高资源利用率。

实际上，云基础设施可以被看作是一个虚拟机管理基础设施，它负责管理和维护大量的虚拟机实例。通过云计算平台，用户可以轻松地创建、启动、停止和管理虚拟机，而无需关心底层的物理硬件设备。因此，云基础设施的核心功能之一就是提供对虚拟化资源的有效管理和利用，以实现高效、可靠和弹性的计算资源分配。