# HDFS

## HDFS是什么

一种分布式文件系统，用于存储和管理大规模数据集的分布式存储解决方案，通过目录树来定位文件。它是分布式文件管理系统的一种

## 适用场景

**适合一次写入，多次读出的场景。**一个文件经过创建、写入和关闭之后就不需要改变。HDFS只支持文件追加，而不支持在任意位置对文件进行修改

## 优缺点

优点

- 高容错性：高容错性：数据自动保存多个副本，它能够通过增加副本的形式，提高容错性。当某一个副本丢失后，它可以根据其他节点上的副本数据自动恢复。
- 适合处理大数据
- 高可扩展性：只需添加更多的节点即可。这种可扩展性使其适用于应对不断增长的数据量。
- 数据本地性：HDFS会在数据节点上存储数据块，这使得计算可以在数据附近进行，减少了网络传输的开销，提高了性能

缺点

延迟问题：通常用于批量数据处理，对于需要低延迟的实时数据访问场景不太适用。读取数据的响应时间可能会较长。做不到向Mysql那样快速相应数据。

无法高效的对大量小文件进行存储：存储大量小文件的话，会占用NameNode大量的内存来存储文件目录和块信息。这样是不可取的，因为NameNode的内存总是有限的，太多的小文件会徒增NameNode的负担，甚至会使其崩溃。

不支持原子性写入操作： HDFS不支持原子性写入操作，这意味着如果多个客户端同时尝试写入同一文件，可能会导致数据不一致性。因此HDFS规定：

- 一个文件只能同一时间只能有一个写，不允许多个线程同时写；
- 仅支持数据追加（append），不支持文件的随机修改。

## **组成架构**

HDFS主要由NameNode、DataNode、SecondaryNameNode、Client组成

1）NameNode（nn）：相当于Master，它是一个管理者

—> 元数据管理：NameNode负责管理HDFS的元素据，包括文件和目录结构、文件的位置信息、文件权限和命名空间等。

—> 块映射：NameNode维护一个块到数据节点的映射表，它记录了每个数据块的副本存储在哪些数据节点上。

—> 客户端请求处理：NameNode处理客户端的文件系统请求，例如创建、删除、重命名文件或目录，以及读取文件的元数据信息。

2）DataNode（dn）：相当于Slave，NameNode下达命令，DataNode执行实际操作。

—> 数据块存储：DataNode负责存储实际的数据块。他们根据NameNode的指示将数据块写入本地磁盘，并在需要时将数据块传送给客户端。

—> 块报告：DataNode周期性地向NameNode发送报告，告知NameNode它们存储了哪些块，并报告数据块的将抗状态。

—> 块复制：如果某个数据块的副本数下降到预定的阈值以下，DataNode会复制丢失的块副本，以维护数据的可靠性。

3）SecondaryNameNode（2nn）：辅助恢复NameNode

—> 元数据备份：SecondaryNameNode的主要作用是定期备份NameNode元数据。需要注意的是它并非NameNode的热备。当NameNode挂掉的时候，它并不能马上替换NameNode并提供服务。**它不会处理实际的文件数据，而只是备份元数据。**

—> 日志合并： Secondary NameNode也负责合并HDFS事务日志（编辑日志），以帮助减小NameNode的编辑日志大小，防止过大的编辑日志导致启动时间过长。

4）Client：客户端

—> 文件切分。文件上传HDFS的时候，Client将文件切分成一个一个的Block，然后进行上传； 

—> 与NameNode交互，获取文件的位置信息； 

—> 与DataNode交互，读取或者写入数据； 

—> Client提供一些命令来管理HDFS，比如NameNode格式化； 

—> Client可以通过一些命令来访问HDFS，比如对HDFS增删查改操作； 



## **HDFS文件块大小**

HDFS中的文件在物理上是分块存储（Block），也就是说数据块（Data  Block）是HDFS中的基本存储单位，它是一个固定大小的数据块，通常默认为128MB（在Hadoop1.x版本中默认为64MB），但可以通过配置参数（dfs.blocksize)适当修改块大小。

**解释：**为什么说处理大量小文件时，数据块设置得太大会造成存储浪费呢？这是因为HDFS默认情况下不会将多个小文件内的数据合并到一个数据块内，即使小文件的实际大小小于数据块大小，HDFS也会将它们分成不同的数据块，不会将多个小文件的数据合并到一个数据块内。这样的话就会造成每个小文件都独占一个数据块，但实际上数据块内存并没有充分利用，就造成了内存浪费。

思考：为什么块大小不能设置太小，也不能设置太大？

（1）HDFS的块设置太小，会增加寻址时间，程序一直在找块的开始位置； 

（2）如果块设置的太大，从磁盘传输数据的时间会明显大于定位这个块开始位置所需的时间。导致程序在处理这块数据时，会非常慢。 

## HDFS读写流程